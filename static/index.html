<!DOCTYPE html>
<meta charset="utf-8" />

<html>

    <head>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>        
        <link rel="stylesheet" href="ws/smartdom.css">

        <script language="javascript" type="text/javascript">
            $(function() {
                var conn = null;

                function msgToHtml(msgRaw) {
                    try {
                    let msg = JSON.parse(msgRaw)
                    console.log("msg", msg)
return `
<div style="display:flex; font-family:monospace; align-items: center;">
    <div style="color: blue;min-width: 230px;max-width: 230px;">${msg.naiveTime}</div>
    <div style="text-align:center;background-color:#fff;font-weight:bold;min-width: 50px;max-width: 50px;color: green;">${msg.level.toUpperCase()}</div>
    <div style="margin: 3px;margin-left:10px;padding: 3px;background-color: #333; color: yellow;mind-width: 800px;max-width: 800px;">${msg.msg}</div>
</div>
`                   }catch(err){
                        return `<div style="color: blue;">${msgRaw}</div>`
                    }
                }

                function log(msg) {
                    var control = $('#log');
                    control.html(control.html() + msgToHtml(msg) + "\n");
                    control.scrollTop(control.scrollTop() + 1000);
                }

                function connect() {
                    disconnect();
                    var wsUri = ( window.location.protocol == 'https:'&&'wss://'||'ws://' ) + window.location.host + '/ws/';
                    conn = new WebSocket(wsUri);
                    log('Connecting...');
                    conn.onopen = function() {
                        log('Connected.');
                        update_ui();
                    };
                    conn.onmessage = function(e) {                        
                        log(e.data);
                    };
                    conn.onclose = function() {
                        log('Disconnected.');
                        conn = null;
                        update_ui();
                    };
                }

                function disconnect() {
                    if (conn != null) {
                        log('Disconnecting...');
                        conn.close();
                        conn = null;
                        update_ui();
                    }
                }

                function update_ui() {
                    var msg = '';
                    if (conn == null) {
                        $('#status').text('( - )');
                        $('#connect').html('Connect');
                    } else {
                        $('#status').text('(' + ( conn.protocol || " + " ) + ')');
                        $('#connect').html('Disconnect');
                    }
                }

                $('#connect').click(function() {
                    if (conn == null) {
                        connect();
                    } else {
                        disconnect();
                    }
                    update_ui();
                    return false;
                });

                $('#send').click(function() {
                    var text = $('#text').val();
                    log('Sending: ' + text);
                    conn.send(text);
                    $('#text').val('').focus();
                    return false;
                });

                $('#text').keyup(function(e) {
                    if (e.keyCode === 13) {
                    $('#send').click();
                    return false;
                    }
                });
            });
        </script>

    </head>
    
    <body>

        <div id="root"></div>

        <div>
            <button id="connect">Connect</button>&nbsp;
            <span id="status">( - )</span>
        </div>

        <hr>

        <div id="log" style="background-color:#aaa;padding: 5px;width:99%;height:400px;max-height:400px;overflow:scroll;padding-left: 5px;"></div>

        <hr>

        <form id="chatform" onsubmit="return false;">
            <input id="text" type="text" />
            <input id="send" type="button" value="Send" />
        </form>

        <script src="ws/smartdom.js"></script>

    </body>

</html>